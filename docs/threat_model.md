# 最小威胁模型 (Minimum Threat Model)

## 文档信息
- **版本**: 1.0.0
- **日期**: 2026-02-08
- **适用范围**: fct, nlp-factor, credit-one

---

## 1. 资产清单

| 资产 | 位置 | 敏感度 | 风险等级 |
|------|------|--------|----------|
| API Keys (ER_API_KEY) | 环境变量 | 高 | Critical |
| 数据库文件 (*.db) | data/, 项目根目录 | 高 | High |
| 配置文件 (config.yaml) | config/ | 中 | Medium |
| 审计日志 | data/audit.db | 高 | High |
| 模型文件 | artifacts/ | 中 | Medium |
| 源代码 | src/, scripts/ | 低 | Low |

---

## 2. 威胁清单 (STRIDE)

### 2.1 Secrets 泄露 (S - Spoofing/Information Disclosure)

| 威胁 | 影响 | 当前状态 | 缓解措施 |
|------|------|----------|----------|
| API Key 硬编码 | 凭证泄露、未授权访问 | ⚠️ 部分存在 | 强制环境变量读取 |
| .env 文件提交到 Git | 历史泄露 | ⚠️ 风险存在 | gitleaks + pre-commit |
| 日志中打印敏感信息 | 信息泄露 | ⚠️ 需审查 | 日志脱敏 |
| 数据库路径遍历 | 数据泄露 | ⚠️ 需防护 | 路径白名单校验 |

### 2.2 危险操作误删 (T - Tampering)

| 威胁 | 影响 | 当前状态 | 缓解措施 |
|------|------|----------|----------|
| 数据库无条件删除 | 数据丢失 | ⚠️ 存在 | --confirm 确认机制 |
| 文件覆盖无备份 | 数据丢失 | ⚠️ 存在 | 自动备份 + 版本控制 |
| 批量删除无审计 | 无法追溯 | ⚠️ 存在 | 审计日志 |
| 危险 SQL 执行 | 数据篡改 | ⚠️ 需防护 | SQL 白名单 |

### 2.3 路径遍历 (E - Elevation of Privilege)

| 威胁 | 影响 | 当前状态 | 缓解措施 |
|------|------|----------|----------|
| 用户输入路径未校验 | 任意文件访问 | ⚠️ 需审查 | 路径规范化 + 白名单 |
| 相对路径逃逸 | 越权访问 | ⚠️ 需防护 | 绝对路径强制 |
| 符号链接攻击 | 敏感文件读取 | ⚠️ 需防护 | 符号链接检测 |

### 2.4 注入攻击 (T/I - Tampering/Information Disclosure)

| 威胁 | 影响 | 当前状态 | 缓解措施 |
|------|------|----------|----------|
| SQL 注入 | 数据泄露/篡改 | ⚠️ 部分存在 | 参数化查询 |
| 命令注入 | 远程代码执行 | ⚠️ 需审查 | 命令白名单 |
| 日志注入 | 日志伪造 | ⚠️ 需防护 | 输入净化 |

### 2.5 数据泄露 (I - Information Disclosure)

| 威胁 | 影响 | 当前状态 | 缓解措施 |
|------|------|----------|----------|
| 敏感数据未脱敏 | 隐私泄露 | ⚠️ 需审查 | 数据分类 + 脱敏 |
| 错误信息暴露 | 系统信息泄露 | ⚠️ 存在 | 错误处理统一化 |
| 临时文件未清理 | 残留数据 | ⚠️ 需防护 | 自动清理机制 |

---

## 3. 数据流图

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  用户输入    │────▶│  输入校验   │────▶│  Guardrails │
└─────────────┘     └─────────────┘     └──────┬──────┘
                                               │
                       ┌───────────────────────┘
                       ▼
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  审计日志    │◀────│  业务逻辑   │◀────│ Secrets管理 │
└─────────────┘     └──────┬──────┘     └─────────────┘
                           │
              ┌────────────┼────────────┐
              ▼            ▼            ▼
        ┌─────────┐  ┌─────────┐  ┌─────────┐
        │ 数据库   │  │ 文件系统 │  │ 外部API │
        └─────────┘  └─────────┘  └─────────┘
```

---

## 4. 风险矩阵

| 风险 | 可能性 | 影响 | 风险等级 | 优先级 |
|------|--------|------|----------|--------|
| Secrets 硬编码 | 高 | 高 | 🔴 Critical | P0 |
| 数据库误删 | 中 | 高 | 🟠 High | P1 |
| 路径遍历 | 中 | 中 | 🟡 Medium | P2 |
| SQL 注入 | 低 | 高 | 🟠 High | P1 |
| 数据泄露 | 中 | 高 | 🟠 High | P1 |

---

## 5. 合规要求

### 5.1 金融合规 (IFRS 9 / Basel III)
- 所有模型决策必须可审计
- 数据修改必须记录变更前后值
- 回滚能力必须验证

### 5.2 数据保护
- PII 数据必须脱敏
- 审计日志保留 7 年
- 加密传输和存储

---

## 6. 验收标准

- [ ] 所有 Secrets 通过环境变量读取
- [ ] 危险操作需要 --confirm 确认
- [ ] 所有操作记录审计日志
- [ ] 输入数据通过校验层
- [ ] gitleaks 无告警
- [ ] 回滚 SOP 文档化
